<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Mobile Metas -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <!-- Site Metas -->
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="shortcut icon" href="/images/logo.png" type="" />
    <title>YourOnlineShop - Product</title>
    <!-- bootstrap core css -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css" />
    <!-- font awesome style -->
    <link href="/css/font-awesome.min.css" rel="stylesheet" />
    <!-- Custom styles for this template -->
    <link href="/css/style.css" rel="stylesheet" />
    <!-- responsive style -->
    <link href="/css/responsive.css" rel="stylesheet" />
	<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
	crossorigin="anonymous"></script>
  </head>
  <body onload="loadProduct(),loadReleatedProduct(), loadRecentOrder()">
    <div class="">
      <!-- header section strats -->
      <header class="header_section"
			style="background-color: rgb(162, 38, 36); box-shadow: 5px 5px 2px; height: 200px;">
			<div class="container heading_center" style="">
				<a class="navbar-brand" href="/home"> <img
					width="150px
                     " src="/images/logo.png" /></a>
			</div>
			<div class="form-group">

				<nav style="display: flex; justify-content: center;"
					class=" mt-xl-5 navbar navbar-expand-lg custom_nav-container ">

					<button class="navbar-toggler" type="button" data-toggle="collapse"
						data-target="#navbarSupportedContent"
						aria-controls="navbarSupportedContent" aria-expanded="false"
						aria-label="Toggle navigation"></button>

					<div class="collapse navbar-collapse" id="navbarSupportedContent">
						<ul class="navbar-nav">
							<div style="background-color: rgb(215, 58, 51);" class="mr-sm-2">
								<a href="/addProduct" class="btn btn-lg">Aggiungi Prodotto <span
									style="color: rgb(43, 43, 43);"
									class="glyphicon glyphicon-plus"></span>
								</a>
							</div>
							<div id="carello" class="mr-sm-2">

								<div class=" dropdown dropdown-item" onclick="">
									<li class="fa fa-shopping-cart " type="button"
										style="font-size: 30px; margin-right: 10px" id="dropdownMenu2"
										data-bs-toggle="dropdown" aria-expanded="false"></li>
									<div class="dropdown-menu" aria-labelledby="dropdownMenu2">
										<li class="">
											<div class="container dropdown-item"
												style="width: max-content;">
												<div class="row" id="dropDownCart"
													style="width: 300px; overflow-y: auto; white-space: nowrap;">

												</div>
										</li> <a href="/shipping" class="btn btn-primary"
											style="margin-top: 10px; margin-left: 10px;">Go to the
											cart</a>
									</div>
								</div>
							</div>
							<div
								style="display: -ms-flexbox; display: flex; -ms-flex-align: center; align-items: center; visibility: hidden;">
								<form class="input-group">

									<input style="width: 180px;" class="form-control mr-sm-2 "
										type="search" placeholder="Search" aria-label="Search">
									<button
										style="width: 70px; color: rgb(215, 58, 51); border-color: rgb(215, 58, 51);"
										class=" form-control btn btn-outline-info my-2 my-sm-0"
										type="submit">
										<span style="color: black">Search 
									</button>
								</form>
							</div>
					</div>
					</ul>
			</div>
			</nav>
	</div>
	</header>		
      <!-- end header section -->
    </div>
    <div id="selectionProduct"></div>
    <section class="product_section layout_padding">
      <div class="container">
        <h2>Releated Product</h2>

        <div class="row" id="tabellaReleatedProduct">
          <div class="col-sm-6 col-md-4 col-lg-4">
            <div class="box">
              <div class="option_container">
                <div class="options">
                  <a href="" class="option1"> Men's Shirt </a>
                  <a href="" class="option2"> Buy Now </a>
                </div>
              </div>
              <div class="img-box">
                <img src="/images/p1.png" alt="" />
              </div>
              <div class="detail-box">
                <h5>Men's Shirt</h5>
                <h6>$75</h6>
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-md-4 col-lg-4">
            <div class="box">
              <div class="option_container">
                <div class="options">
                  <a href="" class="option1"> Add To Cart </a>
                  <a href="" class="option2"> Buy Now </a>
                </div>
              </div>
              <div class="img-box">
                <img src="/images/p2.png" alt="" />
              </div>
              <div class="detail-box">
                <h5>Men's Shirt</h5>
                <h6>$80</h6>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- jQery -->
    <script src="/js/jquery-3.4.1.min.js"></script>
    <!-- popper js -->
    <script src="/js/popper.min.js"></script>
    <!-- bootstrap js -->
    <script src="/js/bootstrap.js"></script>
    <!-- custom js -->
    <script src="/js/custom.js"></script>
  </body>
  <!-- Script per acquisire i prodotti dell'ultimo ordine (non ancora acquistato) di uno specifico utente  -->
  <script type="text/javascript">
    var objectKeyOrdine;
    var theUtenteObjectKey;
    function loadRecentOrder(e) {
      const url = window.location.href;
      const urlStrip = url.split("/");
      objectKeyOrdine = urlStrip.at(-1);
      if ((urlStrip.length = 6)) {
        theUtenteObjectKey = urlStrip.at(-2);
      }
      var httpRequest = new XMLHttpRequest();
      httpRequest.onreadystatechange = reactionFirst;
      httpRequest.open(
        "GET",
        "http://localhost:8080/store/ordine/current-ordine/" +
          theUtenteObjectKey,
        true
      );
      httpRequest.send();
    }
    function reactionFirst(e) {
      if (e.target.readyState == XMLHttpRequest.DONE) {
        var i = 0;
        var json = e.target.responseText;
        var jsonparse = JSON.parse(json);
        putTheProductOnPage(jsonparse);
      }
    }
    //lista ID prodotti dell'ultimo ordine
    var productsId = [];
    var totalCostNumber = Number("0");
    function putTheProductOnPage(content) {
      objectKeyOrdine = content.ordineId;
      console.log(objectKeyOrdine);
      console.log(content);
      $.ajax({
        type: "GET",
        url:
          "http://localhost:8080/store/order-item/findByTheOrdine/" +
          objectKeyOrdine,
        success: function (result) {
          console.log(
            "http://localhost:8080/store/order-item/findByTheOrdine/"
          );
          console.log(result.content);
          for (var i = 0; i < result.content.length; i++) {
            if (result.content[i].theOrdineObjectKey == objectKeyOrdine) {
              console.log(objectKeyOrdine);
              productsId.push(result.content[i].theProductObjectKey);
            }
          }
          console.log(productsId);

          // // 		//chiamata allo stock per prendere i dati dei prodotti, in modo tale da poterli raffigurare front-end
          for (var i = 0; i < productsId.length; i++) {
            $.ajax({
              type: "GET",
              url: "http://localhost:8080/database/product/" + productsId[i],
              success: function (result) {
                console.log(result);
                addProductToForm(result);
              },
              error: function (e) {
                alert("Errore" + e);
              },
            });
          }
          productsId = [];
        },
        error: function (e) {
          alert("Errore" + e);
        },
      });
    }

    function addProductToForm(productDetail) {
      var dropDownCart = document.getElementById("dropDownCart");
      dropDownCart.insertAdjacentHTML(
        "beforeend",
        '<div class="col-sm-6 col-md-4 col-lg-4 mt-2" id="ProductOnCart' +
          productDetail.productId +
          '">' +
          '<div class="box">' +
          '<div class="img-box">' +
          '	<img src="' +
          productDetail.imageUrl +
          '" width="50px"' +
          '		style="margin-left: 20px;">' +
          "	</div>" +
          "</div>" +
          "</div>" +
          '<div class=" col-lg-4" style="overflow-x: auto;white-space: nowrap;width: 50px;">' +
          '<div class="box" >' +
          '	<div class=" detail-box" >' +
          "		<h5>" +
          productDetail.productName +
          "</h5>" +
          "		<h5>" +
          productDetail.cost +
          "€</h5>" +
          "	</div>" +
          "	</div>" +
          "</div>" +
          '<div class=" col-lg-4">' +
          '<div class="detail-box" >' +
          '<h5 id="AmountOnCart' +
          productDetail.productId +
          '">' +
          "x " +
          "</div>" +
          "</h5>" +
          "	</div>" +
          "	</div>"
      );
      RefreshAmount(productDetail.productId);
    }

    function RefreshAmount(productId) {
      $.ajax({
        type: "GET",
        url:
          "http://localhost:8080/store/order-item/" +
          objectKeyOrdine +
          "~" +
          productId,
        success: function (result) {
          const AmountProductOnCart = document.getElementById(
            "AmountOnCart" + productId
          );
          AmountProductOnCart.innerHTML = "x " + result.amount;
        },
        error: function (e) {
          alert("Errore" + e);
        },
      });
    }
  </script>

  <script>
    const url = window.location.href;
    const urlStrip = url.split("/");
    const id = urlStrip.at(-1);
    console.log("Questo è l'id del prodotto:" + id);

    function loadProduct(e) {
      var httpRequest = new XMLHttpRequest();
      httpRequest.onreadystatechange = reaction;
      httpRequest.open(
        "GET",
        "http://localhost:8080/database/product/" + id,
        true
      ); //TODO http://localhost:8080/database/product/{id}
      httpRequest.send();
    }
    function reaction(e) {
      if (e.target.readyState == XMLHttpRequest.DONE) {
        var i = 0;
        var prod = e.target.responseText;
        var prodparse = JSON.parse(prod);
        viewProduct("selectionProduct", prodparse);
      }
    }
    function viewProduct(tableID, sond) {
      var table = document.getElementById(tableID);
      const image = sond.imageUrl;
      const cost = sond.cost;
      const name = sond.productName;
      const desc = sond.description;
      table.insertAdjacentHTML(
        "beforeend",
        '<section class="product_choosed layout_padding" width="100px">' +
          '         <div class="container">' +
          '            <div class="row" >' +
          '               <div class="col-sm-6 col-md-4 col-lg-4" >' +
          '                  <div class="box" >' +
          '                     <div class="img-box" >' +
          '                        <img src="' +
          image +
          '" alt="">' +
          "                     </div>" +
          "                  </div>" +
          "               </div>" +
          '               <div class=" col-lg-8" >' +
          '                  <div class="box">' +
          '                     <div class=" detail-box">' +
          '                        <p style="font-size:35px;">' +
          "                           " +
          name +
          "" +
          "                        </p>" +
          '                        <p style="font-size:35px;">' +
          "                           " +
          cost +
          "€" +
          "                        </p>" +
          "                     </div>" +
          "                     <hr>" +
          '                     <br><p style="font-size:20px;">' +
          "                        " +
          desc +
          "" +
          "                     </p>" +
          '                     <div style="width: 100px; margin-top: 50px;" >' +
          '                        <input style="width: 200px; font-size:20px;" type="number" aria-label="First name" class="form-control quantita" value="1" >' +
          "                     </div>" +
          '                     <div style="width: 250px;">' +
          "                        <hr>" +
          '                        <input style="width: 200px; font-size:20px;" type="button" aria-label="First name" class="form-control btn-primary " value="Add to Cart">' +
          "                     </div>" +
          "                  </div>" +
          "               </div>" +
          "            </div>" +
          "         </div>" +
          "         </section>"
      );
      console.info(sond);
    }
    console.log("ciao pippo2");
  </script>
  <script>
    function loadReleatedProduct() {
      var tabellaReleatedProduct = document.getElementById(
        "tabellaReleatedProduct"
      );
      $.ajax({
        type: "GET",
        url: "http://localhost:8080/database/product/all",
        success: function (result) {
          const contentAllProduct = result;
          var mapAllProduct = new Map();
          for (var i = 0; i < contentAllProduct.length; i++) {
            mapAllProduct.set(
              contentAllProduct[i].productName,
              contentAllProduct[i].productId
            );
          }
          $.ajax({
            type: "GET",
            url: "http://localhost:5000/recommend",
            success: function (result) {
              //TODO da modificare con result
              result = JSON.parse(resultProva);
              const json = '{"ciao": 1, "hola": 2}';
              console.log(mapAllProduct);
              var mapResultEngine = new Map();
              const obj = JSON.parse(resultProva, (key, value) => {
                mapResultEngine.set(value, key);
                return value;
              });
              mapResultEngine = mapResultEngine.sort();
              const iterator = mapResultEngine.keys();
              var res = iterator.next().value;
              while (res != null) {
                console.log(mapResultEngine.get(res));
                tabellaReleatedProduct.insertAdjacentHTML(
                  "beforeend",
                  '<div class="col-sm-6 col-md-4 col-lg-4">' +
                    '<div class="box">' +
                    '<div class="option_container">' +
                    '<div class="options">' + //fa in modo di prendere l'id attraverso il nome del prodotto
                    '<a href="" class="option1"> Add to Cart</a> <a href="/product/' +
                    mapAllProduct.get(mapResultEngine.get(res)) +
                    '" ' +
                    'class="option2"> View The Product </a>' +
                    "</div>" +
                    "</div>" +
                    '<div class="img-box">' +
                    '<img src="/images/p1.png" alt="">' +
                    "</div>" +
                    '<div class="detail-box">' +
                    "<h5>" +
                    mapResultEngine.get(res) +
                    "</h5>" +
                    "</div>" +
                    "</div>" +
                    "</div>"
                );
                res = iterator.next().value;
              }
            },
            error: function (e) {
              resultProva = "{" + '"Scarpe": 1,' + '"Pizza": 0.2' + "}";
              const map = new Map();
              const obj = JSON.parse(resultProva, (key, value) => {
                map.set(value, key);
                return value;
              });
              const sortedMap = new Map([map].sort());
              const iterator = map.keys();
              var res = iterator.next().value;
              while (res >= 0) {
                console.log(map.get(res));
                tabellaReleatedProduct.insertAdjacentHTML(
                  "beforeend",
                  '<div class="col-sm-6 col-md-4 col-lg-4">' +
                    '<div class="box">' +
                    '<div class="option_container">' +
                    '<div class="options">' +
                    '<a href="" class="option1"> Add to Cart</a> <a href="/product/' +
                    mapAllProduct.get(mapResultEngine.get(res)) +
                    '" ' +
                    'class="option2"> View The Product </a>' +
                    "</div>" +
                    "</div>" +
                    '<div class="img-box">' +
                    '<img src="/images/p1.png" alt="">' +
                    "</div>" +
                    '<div class="detail-box">' +
                    "<h5>" +
                    map.get(res) +
                    "</h5>" +
                    "</div>" +
                    "</div>" +
                    "</div>"
                );
                res = iterator.next().value;
                alert("Errore" + e);
              }
            },
          });
        },
        error: function (e) {
          alert("Errore" + e);
        },
      });
    }
  </script>
</html>
